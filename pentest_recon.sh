#!/bin/bash

# 定義報告檔案名稱
REPORT_FILE="report.txt"

# 初始化報告檔案
echo "初步滲透測試報告" > $REPORT_FILE
echo "==================" >> $REPORT_FILE
echo "生成時間: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 取得目標主機的作業系統類型
echo "請選擇目標主機的作業系統:"
echo "1) Linux"
echo "2) Windows"
read -p "請輸入 1 或 2: " OS_TYPE

if [[ "$OS_TYPE" != "1" && "$OS_TYPE" != "2" ]]; then
    echo "無效輸入，腳本結束。"
    exit 1
fi

# 取得目標主機的 IP
read -p "請輸入目標主機的 IP 地址: " TARGET_IP

# 檢查 IP 格式是否合法
if ! [[ $TARGET_IP =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "無效的 IP 地址格式，腳本結束。"
    exit 1
fi

# 執行基本掃描
echo "執行基本掃描中，請稍候..."

# 執行 whois 查詢
echo "[*] 執行 whois 查詢..." >> $REPORT_FILE
whois $TARGET_IP >> $REPORT_FILE 2>/dev/null
echo "" >> $REPORT_FILE

# 執行 nmap 掃描
echo "[*] 執行 nmap 掃描..." >> $REPORT_FILE
nmap -A $TARGET_IP >> $REPORT_FILE 2>/dev/null
echo "" >> $REPORT_FILE

# 如果目標是 Linux 主機
if [[ "$OS_TYPE" == "1" ]]; then
    echo "目標為 Linux 主機，執行相關工具..."
    
    # 使用 enum4linux 探勘目標
    echo "[*] 執行 enum4linux 探勘..." >> $REPORT_FILE
    enum4linux -a $TARGET_IP >> $REPORT_FILE 2>/dev/null
    echo "" >> $REPORT_FILE

    # 搜尋公開目錄
    echo "[*] 嘗試搜尋公開目錄 (smbclient)..." >> $REPORT_FILE
    smbclient -L //$TARGET_IP -N >> $REPORT_FILE 2>/dev/null
    echo "" >> $REPORT_FILE
else
    # 如果目標是 Windows 主機
    echo "目標為 Windows 主機，執行相關工具..."
    
    # 使用 smbclient 檢查共享資源
    echo "[*] 執行 smbclient 探勘..." >> $REPORT_FILE
    smbclient -L //$TARGET_IP -N >> $REPORT_FILE 2>/dev/null
    echo "" >> $REPORT_FILE

    # 使用 rpcclient 進行基礎 RPC 探測
    echo "[*] 執行 rpcclient 探勘..." >> $REPORT_FILE
    rpcclient -U "" $TARGET_IP -c "srvinfo" >> $REPORT_FILE 2>/dev/null
    echo "" >> $REPORT_FILE
fi

# 顯示完成訊息
echo "測試完成，報告已生成: $REPORT_FILE"
